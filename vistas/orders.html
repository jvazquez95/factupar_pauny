<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Órdenes Pendientes - Llamador</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-size: 1.2em;
    }
    .child-row {
      background-color: #e9ecef;
    }
    .btn-terminate {
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div class="container-fluid mt-4">
    <h1 class="text-center">Órdenes Pendientes</h1>
    <table id="tblOV" class="table table-striped table-bordered" width="100%">
      <thead>
        <tr>
          <th>ID Orden Venta</th>
          <th>Razón Social</th>
          <th>Detalle de Orden</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Se llenará dinámicamente -->
      </tbody>
    </table>
  </div>

  <!-- Audio de aviso -->
  <audio id="alertAudio">
    <source src="alerta.mp3" type="audio/mpeg">
    Tu navegador no soporta audio HTML5.
  </audio>

  <!-- jQuery, Bootstrap JS, DataTables JS y SweetAlert2 JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

  <script>
    // Función para construir la tabla de detalle de cada orden (child row)
    function formatDetalle(detalle) {
      let html = '<table class="table table-bordered child-row" width="100%">';
      html += '<thead><tr>';
      html += '<th>Artículo</th>';
      html += '<th>Descripción</th>';
      html += '<th>Cantidad</th>';
      html += '</tr></thead><tbody>';
      detalle.forEach(function(det) {
        html += '<tr>';
        html += '<td>' + det.Articulo_idArticulo + '</td>';
        html += '<td>' + det.descripcion + '</td>';
        html += '<td>' + det.cantidad + '</td>';
        html += '</tr>';
      });
      html += '</tbody></table>';
      return html;
    }

    // Función para cargar órdenes pendientes usando AJAX
    function cargarOrdenes() {
      $.ajax({
        url: "https://factupar.com.py/mineraqua/api/public/usuario/getOVPending",
        type: "POST",
        dataType: "json",
        success: function(response) {
          let orders = [];
          // Se asume que la respuesta es un array de órdenes o tiene la clave 'usuario'
          if (Array.isArray(response)) {
            orders = response;
          } else if (response.usuario) {
            orders.push(response.usuario);
          }
          // Inicializar DataTable
          let table = $('#tblOV').DataTable({
            data: orders,
            destroy: true,
            columns: [
              { data: "idOrdenVenta" },
              { data: "razonSocial" },
              { 
                data: "detalle",
                render: function(data, type, row) {
                  if (data && data.length > 0) {
                    return formatDetalle(data);
                  }
                  return "";
                }
              },
              { 
                data: null,
                render: function(data, type, row) {
                  // Botón para terminar la orden (por fila)
                  return '<button class="btn btn-danger btn-terminate" onclick="terminarOrden(' + row.idOrdenVenta + ')">Terminar Orden</button>';
                }
              }
            ],
            language: {
              url: "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
            }
          });

          // Si hay órdenes, reproducir el sonido de aviso
          if (orders.length > 0) {
            $("#alertAudio")[0].play();
          }
        },
        error: function(err) {
          console.error("Error al cargar órdenes:", err);
        }
      });
    }

    // Función para finalizar una orden y mostrar SweetAlert
    function terminarOrden(idOrdenVenta) {
      $.ajax({
        url: "https://factupar.com.py/mineraqua/api/public/usuario/finishOrder",
        type: "POST",
        data: { idOrdenVenta: idOrdenVenta },
        dataType: "json",
        success: function(response) {
          Swal.fire({
            icon: 'success',
            title: 'Orden Finalizada',
            text: 'La orden ' + idOrdenVenta + ' se ha finalizado correctamente.',
            timer: 2000,
            showConfirmButton: false
          });
          // Recargar las órdenes pendientes después de un breve retardo
          setTimeout(cargarOrdenes, 1500);
        },
        error: function(err) {
          console.error("Error al finalizar la orden:", err);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al finalizar la orden ' + idOrdenVenta,
          });
        }
      });
    }

    $(document).ready(function() {
      cargarOrdenes();
      // Refrescar órdenes cada 30 segundos (opcional)
      setInterval(cargarOrdenes, 30000);
    });
  </script>
</body>
</html>
