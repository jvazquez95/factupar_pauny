<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reporte de Seguimiento – Vista Gerencial</title>

  <!-- Bootstrap, DataTables & Buttons -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.5/css/buttons.dataTables.min.css"/>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.6.5/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.6.5/js/buttons.html5.min.js"></script>

  <!-- Google Maps JS + geometry -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVbCmKkfBfmcsC5zjkk70WttiFIcxdWHI&libraries=geometry"></script>

  <style>
    #map{height:600px;width:100%}
    .button-overlay{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:1000}
    .warning{background:#ffdddd!important}
    #imageModal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;justify-content:center;align-items:center;z-index:9999}
    #imageModal img{max-height:90%;max-width:90%;border-radius:8px;box-shadow:0 0 20px #000}
  </style>
</head>

<body class="bg-light">

<div class="container">
  <h2 class="mt-4">Filtros</h2>
  <form id="filterForm" class="form-inline">
    <select id="vehiculo" class="form-control mr-3"></select>
    <input type="date" id="fechaInicio" class="form-control mr-2"/>
    <input type="date" id="fechaFin"    class="form-control mr-2"/>
    <button class="btn btn-primary">Aplicar</button>
  </form>

  <!-- KPI cards -->
  <div id="kpiRow" class="row d-none text-center my-4">
    <div class="col-md-3 mb-2"><div class="card bg-primary text-white"><div class="card-body"><h6>Total Ventas</h6><h2 id="kpiTotal"></h2></div></div></div>
    <div class="col-md-3 mb-2"><div class="card bg-success text-white"><div class="card-body"><h6>Dentro de&nbsp;Radio</h6><h2 id="kpiOk"></h2></div></div></div>
    <div class="col-md-3 mb-2"><div class="card bg-danger text-white"><div class="card-body"><h6>Fuera de&nbsp;Radio</h6><h2 id="kpiOff"></h2></div></div></div>
    <div class="col-md-3 mb-2"><div class="card bg-warning text-dark"><div class="card-body"><h6>% Desvío</h6><h2 id="kpiPct"></h2></div></div></div>
  </div>

  <div id="map" class="mb-2"></div>

  <p><span class="badge badge-success">&nbsp;&nbsp;</span> Dentro de radio&nbsp;&nbsp;
     <span class="badge badge-danger">&nbsp;&nbsp;</span> Fuera de radio</p>

  <h3 class="mt-4">Detalle</h3>
  <table id="resultTable" class="display nowrap" style="width:100%">
    <thead>
      <tr><th>#</th><th>Cliente</th><th>Fecha Tx</th><th>Factura</th>
          <th>Fecha Fac.</th><th>Total</th><th>Dist. (m)</th><th>Venta</th>
          <th>Dirección</th><th>Imagen</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
<!-- Modal imagen -->
<div id="imageModal" class="flex"><img id="modalImage"/></div>

<script>
/* ---------- utilidades ---------- */
const today = () => new Date().toISOString().slice(0,10);
const formatNum = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',');
$('#fechaInicio,#fechaFin').val(today());

/* ---------- mapa y estado ---------- */
let map, infoWin, table;
let markers   = [];
let polylines = [];
const radioOK = 50; // m

const iconVeh = {url:'https://maps.google.com/mapfiles/ms/icons/truck.png',scaledSize:new google.maps.Size(28,28)};
const iconOk  = {url:'https://maps.google.com/mapfiles/ms/icons/green-dot.png',scaledSize:new google.maps.Size(28,28)};
const iconBad = {url:'https://maps.google.com/mapfiles/ms/icons/red-dot.png',  scaledSize:new google.maps.Size(28,28)};

/* ---------- reset ---------- */
function resetMapa(){
  polylines.forEach(l=>l.setMap(null)); polylines.length=0;
  markers.forEach(m=>m.setMap(null));   markers.length  =0;
  infoWin.close();
  table.clear().draw();
}

/* ---------- init map ---------- */
function initMap(){
  map = new google.maps.Map(document.getElementById('map'),{
    zoom:12, center:{lat:-25.35,lng:-57.55}
  });
  infoWin = new google.maps.InfoWindow();
  $('#filterForm').on('submit',e=>{e.preventDefault(); cargarDatos();});
}

/* ---------- combos ---------- */
function cargarVehiculos(){
  $.post('https://mineraqua.com.py/mineraqua/api/public/usuario/reporte_vehiculos',d=>{
    d.forEach(v=>$('#vehiculo').append(new Option(v.nombreReferencia,v.idVehiculo)));
  },'json');
}

/* ---------- backend ---------- */
function cargarDatos(){
  resetMapa();                                     // ← limpia antes de cada consulta
  const veh=$('#vehiculo').val(),
        f1 =$('#fechaInicio').val(),
        f2 =$('#fechaFin').val();

  $.post('https://mineraqua.com.py/mineraqua/api/public/usuario/reporte_seguimiento',
        {vehiculo:veh,fechaInicio:f1,fechaFin:f2},
        procesarDatos,'json');
}

/* ---------- procesar respuesta ---------- */
function procesarDatos(data){
  let dentro=0, fuera=0;

  data.forEach((d,i)=>{
    const vLL = new google.maps.LatLng(d.lat_venta ,d.lng_venta );
    const cLL = new google.maps.LatLng(d.lat_direccion,d.lng_direccion);
    const dist = Math.round(google.maps.geometry.spherical.computeDistanceBetween(vLL,cLL));
    const ok   = dist<=radioOK;

    markers.push(new google.maps.Marker({position:vLL,map,label:`V${i+1}`,icon:iconVeh}));

    const dirMarker = new google.maps.Marker({position:cLL,map,label:`${i+1}`,icon: ok?iconOk:iconBad});
    markers.push(dirMarker);

    dirMarker.addListener('click',()=>{
      infoWin.setContent(`<strong>${d.razonSocial}</strong><br>Dist.: ${dist} m`);
      infoWin.open(map,dirMarker);
    });

    const line = new google.maps.Polyline({
      path:[vLL,cLL], map,
      strokeColor: ok?'#00aa00':'#ff0000',
      strokeWeight:2
    });
    polylines.push(line);

    ok ? dentro++ : fuera++;

    const linkVenta     = `<a href="#" onclick="goMaps(${d.lat_venta},${d.lng_venta})">Venta</a>`;
    const linkDireccion = `<a href="#" onclick="goMaps(${d.lat_direccion},${d.lng_direccion})">Dir.</a>`;

    table.row.add([
      i+1, d.razonSocial, d.fechaTransaccion, `${d.serie}-${d.nroFactura}`,
      d.fechaFactura, formatNum(d.total), dist, linkVenta, linkDireccion,
      d.imagen ? `<img src="https://mineraqua.com.py/mineraqua/files/direcciones/${d.imagen}" style="width:70px">` : ''
    ]);
  });

  table.draw();

  const total=dentro+fuera;
  $('#kpiTotal').text(total);
  $('#kpiOk')   .text(dentro);
  $('#kpiOff')  .text(fuera);
  $('#kpiPct')  .text(total ? ((fuera/total)*100).toFixed(1)+'%' : '0%');
  $('#kpiRow')  .removeClass('d-none');
}

/* ---------- util extra ---------- */
function goMaps(lat,lng){
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,'_blank');
}
$('#imageModal').on('click',()=>$('#imageModal').hide());

/* ---------- DataTable (una sola vez) ---------- */
table = $('#resultTable').DataTable({
  dom:'Bfrtip',
  buttons:['csvHtml5','excelHtml5'],
  order:[[2,'desc']]
});

/* ---------- init ---------- */
$(document).ready(()=>{cargarVehiculos();});
google.maps.event.addDomListener(window,'load',initMap);
</script>
</body>
</html>
